/*
 \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 \ Empresa.: Denny Azevedo - Marilene Esquiavoni
 \ Programa: HOT44.PRG
 \ Data....: 30-08-2000
 \ Sistema.: MILENIUM - Automa‡„o Hoteleira
 \ Funcao..: Emiss„o de Relat¢rio do Boletim de Movimento Di rio - BMD  
 \ Analista: Denny Azevedo - Marilene Esquiavoni
 \ Criacao.: Gerado pelos analistas
 \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
*/

#INCLUDE 'INKEY.CH'
#INCLUDE 'ACHOICE.CH'
#INCLUDE 'BOX.CH'
#INCLUDE 'SETCURS.CH'

LOCAL MDATA

SET DATE TO BRIT

//APARTIR DAQUI - DIA,TIPO DE DESPESA
MDIA=0
MAME=0
MTEL=0
MLAV=0
MFRI=0
MCON=0
MCOP=0
MDIV=0
MRES=0
SALDOPAX=0
MRE=0
ENTRAPAX=0
SALDOANT=0
MMESSALTRAN=0
TBRUTO=0
SALDODIA=0
TAXASER=0
MDIN=0
MCHE=0
MCRE=0
MRDA=0
MCOB=0
SAIDAPAX=0
SALDODPAX=0
STOTALPAX=0
SALDOAPTO=0
ENTRAAPTO=0
SAIDAAPTO=0
SALDORECE=0
ENTRARECE=0
SAIDARECE=0
SAIRECE=0
SALDDAPTO=0
SALDDPAX=0
SALDDRECE=0
CORTESIA=0
SALDODP=0

JANELA(01,10,24,15,57,"")
@ 11,28 SAY "Informe a Data e a Hora !"
DO WHILE .T.
   MDATA=CONTROLE->BMD
   MHBMD=CONTROLE->HBMD
   SET CURSOR ON
   @ 14,30 GET MDATA  PICT "@D"       VALID(!EMPTY(MDATA))
   @ 14,46 GET MHBMD  PICT "@R 99:99" VALID(!EMPTY(MHBMD))
   READ
   SET CURSOR ON
   IF LASTKEY()=K_ESC
      JANELA(02)
      RETURN
   ENDIF
   IF MDATA>CONTROLE->BMD .OR. MHBMD>CONTROLE->HBMD
      MENS('Data ou Hora Invalida !!!')
   ELSE
      JANELA(01,13,53,16,66)
      VERI=01
      @ 14,54 PROMPT "Verificacao "
      @ 15,54 PROMPT "Atualizacao "
      MENU TO VERI
      JANELA(02)
      IF VERI!=00
         EXIT
      ENDIF
   ENDIF
ENDDO
JANELA(02)
PRIV NUCOP:=1,COPRIN:=1
JANELA(01,09,18,14,63,"Solicitacao de Copias")
@ 12,25 SAY "Informe o Numero de Copias :"
SET CURSOR ON
@ 12,54 GET NUCOP PICT "99" RANGE 1,99
READ
SET CURSOR OFF
JANELA(02)
IF LASTKEY()=K_ESC
   RETURN
ENDIF
JANELA(01,09,18,14,63,"Verificacao de Impressora")
@ 12,21 SAY "Prepare o Formulario e pressione <ENTER> "
INKEY(0)
DO WHILE .T.
   IF !ISPRINTER()
      @ 12,21 SAY "Impressora nao esta Pronta ou sem Papel "
      INKEY(0.5)
      IF LASTKEY()=K_ESC
         JANELA(02)
         RETURN
      ENDIF
   ELSE
      EXIT
   ENDIF
ENDDO
JANELA(02)
IF LASTKEY()=K_ESC
   RETURN
ENDIF
JANELA(1,11,15,15,66,"Imprimindo Relatorio BMD")
@ 14,17 SAY 'Aguarde um momento - Executando o Processamento'

TDATA=DTOC(CONTROLE->BMD)
INICIO=SUBSTR(TDATA,1,2)
IF INICIO='01'
   SELE 11
   TRASPORT=SOMATORIA
   INIC_VAR()
   REPL MESSALANT WITH TRASPORT
ENDIF

//ATRIBUINDO VALOR PARA O SALDO ANTERIOR
SALDOANT=BMD->MESSALDOT

SELE 11
IGUAL_VAR()

SELE 05
SET FILTER TO ((DTENT>=MDATA) .AND. (DTSAI<=MDATA) .AND. (HENT>=MHBMD))
DBGOTOP()
WHILE !EOF()
   SELE 09
   SET FILTER TO CODIGO=REGISTRO->CODIGO
   DBGOTOP()
   WHILE !EOF()            //CALCULA SOMA DE TIPO DE DESPESA
      DO CASE
         CASE TIPODESP=1
            SELE 06
            LOCATE FOR CODIGO=MOVIM->CODIGO
            IF FOUND()
               DESCONT=VALOR
//               SELE 02
//               LOCATE FOR APTO=MOVIM->APTO
               CORTESIA=CORTESIA+DESCONT
            ENDIF
            SELE 09
            MDIA=MDIA+VALOR
         CASE TIPODESP=2
            MAME=MAME+VALOR
         CASE TIPODESP=3
            MTEL=MTEL+VALOR
         CASE TIPODESP=4
            MLAV=MLAV+VALOR
         CASE TIPODESP=5
            MFRI=MFRI+VALOR
         CASE TIPODESP=6
            MCON=MCON+VALOR
         CASE TIPODESP=7
            MCOP=MCOP+VALOR
         CASE TIPODESP=8
            MDIV=MDIV+VALOR
         CASE TIPODESP=9
            MRES=MRES+VALOR
      ENDCASE
      DBSKIP()
   ENDDO
   SELE 05
   DBSKIP()
ENDDO
SELE 09
SET FILTER TO
SALDODIA=MDIA+MAME+MTEL+MLAV+MFRI+MCON+MCOP+MDIV+MRES    //SOMA SALDO DO DIA
TAXASER=SALDODIA*0.1

TBRUTO=SALDODIA+SALDOANT+TAXASER

//APARTIR DAQUI - DIA, FORMAS DE PAGAMENTO

SELE 05
SET FILTER TO DTSAI=MDATA
DBGOTOP()
DO WHILE !EOF()
   SELE 10                 //CALCULA SOMA DE TIPO DE PAGAMENTO
   SET FILTER TO CODIGO=REGISTRO->CODIGO
   DBGOTOP()
   WHILE !EOF()
      DO CASE
         CASE FORMAPAG=1
            MDIN=MDIN+VALOR
         CASE FORMAPAG=2
            MCHE=MCHE+VALOR
         CASE FORMAPAG=3
            MCRE=MCRE+VALOR
         CASE FORMAPAG=4
            MRDA=MRDA+VALOR
         CASE FORMAPAG=5
            MCOB=MCOB+VALOR
      ENDCASE
      DBSKIP()
   ENDDO
   SELE 05
   DBSKIP()
ENDDO
SALDOTRAN=TBRUTO-(MDIN+MCHE+MCRE+MRDA+MCOB)
MMESSALDOT=SALDOTRAN

//APARTIR DAQUI - MOVIMENTO DO DIA, SOMENTE PAX

SELE 05
SET FILTER TO (((DTENT>MDATA) .AND. (DTSAI<MDATA)) .AND. ((HENT>MHBMD) .AND. (HSAI<MHBMD)))
DBGOTOP()
DO WHILE !EOF()
   SALDOPAX=SALDOPAX+PAX
   DBSKIP()
ENDDO
SET FILTER TO DTENT=MDATA
DBGOTOP()
WHILE !EOF()
   ENTRAPAX=ENTRAPAX+PAX
   DBSKIP()
ENDDO
STOTALPAX=SALDOPAX+ENTRAPAX
SET FILTER TO DTSAI=MDATA
DBGOTOP()
WHILE !EOF()
   SAIDAPAX=SAIDAPAX+PAX
   DBSKIP()
ENDDO
SALDODPAX=STOTALPAX-SAIDAPAX
OCUPAPAX=(SALDODPAX/190)*100

//APARTIR DAQUI - MOVIMENTO DO DIA, APTO

SET FILTER TO (((DTENT>MDATA) .AND. (DTSAI<=MDATA)) .AND. ((HENT>MHBMD) .AND. (HSAI<=MHBMD)))
DBGOTOP()
WHILE !EOF()
   SALDOAPTO=SALDOAPTO+1
   DBSKIP()
ENDDO
SET FILTER TO DTENT=MDATA
DBGOTOP()
WHILE !EOF()
   ENTRAAPTO=ENTRAAPTO+1
   DBSKIP()
ENDDO
STOTALAPTO=SALDOAPTO+ENTRAAPTO
SET FILTER TO DTSAI=MDATA
DBGOTOP()
WHILE !EOF()
   SAIDAAPTO=SAIDAAPTO+1
   DBSKIP()
ENDDO
SALDODAPTO=STOTALAPTO-SAIDAAPTO
OCUPAAPTO=(SALDODAPTO/95)*100

//APARTIR DAQUI - MOVIMENTO DO DIA, RECEITA

SELE 05
SET FILTER TO (((DTENT>=MDATA) .AND. (DTSAI<=MDATA)) .AND. ((HENT>=MHBMD) .AND. (HSAI<=MHBMD)))
DBGOTOP()
FOR I=1 TO SALDOAPTO
   SELE 02
   DBGOTOP()
   LOCATE FOR APTO=REGISTRO->APTO
   SALDORECE=SALDORECE+DIARIA
   SELE 05
   DBSKIP()
NEXT I
SET FILTER TO DTENT=MDATA
DBGOTOP()
FOR I=1 TO ENTRAAPTO
   SELE 02
   DBGOTOP()
   LOCATE FOR APTO=REGISTRO->APTO
   ENTRARECE=ENTRARECE+DIARIA
   SELE 05
   DBSKIP()
NEXT
STOTALRECE=SALDORECE+ENTRARECE
SET FILTER TO DTSAI=MDATA
DBGOTOP()
FOR I=1 TO SALDDAPTO
   SELE 02
   DBGOTOP()
   LOCATE FOR APTO=REGISTRO->APTO
   SAIRECE=SAIRECE+DIARIA
   SELE 05
   DBSKIP()
NEXT I
SALDODRECE=STOTALRECE-SAIDARECE
VALPAX=SALDODRECE/SALDDPAX
VALAPTO=SALDODRECE/SALDODAPTO

//APARTIR DAQUI - MES, TIPODE DESPESA

SELE 11
DBGOTOP()
MMESDIA=MESDIA+MDIA
MMESSAME=MESSAME+MAME
MMESTEL=MESTEL+MTEL
MMESLAV=MESLAV+MLAV
MMESFRI=MESFRI+MFRI
MMESCON=MESCON+MCON
MMESCOP=MESCOP+MCOP
MMESDIV=MESDIV+MDIV
MMESRES=MESRES+MRES

//APARTIR DAQUI - O RESTO DA RELACAO

MMESSDIA=MMESDIA+MMESSAME+MMESTEL+MMESLAV+MMESFRI+MMESCON+MMESCOP+MMESDIV+MMESRES
MMESTXSER=MMESSDIA*0.1
MMESTBRUTO=MMESSDIA+MMESTXSER+(BMD->MESSALANT)
MMESDIN=MESDIN+MDIN
MMESCHE=MESCHE+MCHE
MMESCRE=MESCRE+MCRE
MMESRDA=MESRDA+MRDA
MMESCOB=MESCOB+MCOB
MMESCORT=MESCORT+CORTESIA

//APARTIR DAQUI - ACUMULADO DO MES, PAX

MMESSALPAX=MESSALPAX+SALDOPAX
MMESENTPAX=MESENTPAX+ENTRAPAX
MMESSTPAX=MMESSALPAX+MMESENTPAX
MMESSAIPAX=MESSAIPAX+SAIDAPAX
MMESSALDP=MMESSTPAX-MMESSAIPAX
MMESOCUPAX=(MMESSALDP/190)*100

//APARTIR DAQUI - ACUMULADO DO MES, APTO

MMESSALAP=MESSALAP+SALDOAPTO
MMESENTAP=MESENTAP+ENTRAAPTO
MMESSTAP=MMESSALAP+MMESENTAP
MMESSAIAP=MESSAIAP+SAIDAAPTO
MMESSDAP=MMESSTAP-MMESSAIAP
MMESOCUAP=(MMESSDAP/95)*100

//APARTIR DAQUI - ACUMULADO DO MES, RECEITA

MMESSALR=MESSALR+SALDORECE
MMESENTRE=MESENTRE+ENTRARECE
MMESSTRE=MMESSALR+MMESENTRE
MMESSAIRE=MESSAIRE+SAIDARECE
MMESSDRE=MMESSTRE-MMESSAIRE
MMESVALREP=MMESSDRE/MMESSALDP
MMESVALREA=MMESSDRE/MMESSDAP

MMESSALTRAN=SALDOTRAN
MSOMATORIA=(BMD->SOMATORIA)+MMESSALTRAN

//IMPRESSAO

SET DEVICE TO PRINTER
@ 01,18 SAY "B O L E T I M   D E   M O V I M E N T O   D I A R I O"
@ PROW()+2,01 SAY Controle->NomHot
@ PROW(),57   SAY "Dia: "
@ PROW(),PCOL()+1   SAY MDATA
@ PROW()+2,01 SAY "==============================================================================="
@ PROW()+2,01 SAY "DESCRICAO"
@ PROW(),34   SAY "DIA"
@ PROW(),63   SAY "MES"
@ PROW()+1,01 SAY "-------------------------------------------------------------------------------"
@ PROW()+1,01 SAY "Diaria"
@ PROW(),29   SAY MDIA      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESDIA   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "American Bar"
@ PROW(),29   SAY MAME      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESSAME  PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Telefone"
@ PROW(),29   SAY MTEL      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESTEL   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Lavanderia"
@ PROW(),29   SAY MLAV      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESLAV   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Frigobar"
@ PROW(),29   SAY MFRI      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESFRI   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Convencao"
@ PROW(),29   SAY MCON      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCON   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Copa"
@ PROW(),29   SAY MCOP      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCOP   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Diversos"
@ PROW(),29   SAY MDIV      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESDIV   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Restaurante"
@ PROW(),29   SAY MRES      PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESRES   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Saldo do Dia"
@ PROW(),29   SAY SALDODIA  PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESSDIA  PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Saldo Anterior"
@ PROW(),29   SAY CHR(27)+CHR(69)     //ENFATIZA O VALOR
@ PROW(),29   SAY SALDOANT  PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY BMD->MESSALANT PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY CHR(27)+CHR(70)
@ PROW()+1,01 SAY "Taxa de Servico"
@ PROW(),29   SAY TAXASER   PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESTXSER PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Total Bruto"
@ PROW(),29   SAY TBRUTO    PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESTBRUTO PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Dinheiro"
@ PROW(),29   SAY MDIN       PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESDIN    PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Cheques"
@ PROW(),29   SAY MCHE       PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCHE    PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "C/Credito"
@ PROW(),29   SAY MCRE       PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCRE    PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "R.D.A."
@ PROW(),29   SAY MRDA       PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESRDA    PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Cobrancas"
@ PROW(),29   SAY MCOB       PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCOB    PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Cortesia Descontos"
@ PROW(),29   SAY CORTESIA   PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESCORT   PICT "@E 99,999,999,999.99"
@ PROW()+1,01 SAY "Saldo a Transportar"
@ PROW(),29   SAY CHR(27)+CHR(69)
@ PROW(),29   SAY SALDOTRAN  PICT "@E 99,999,999,999.99"
@ PROW(),58   SAY MMESSALDOT PICT "@E 99,999,999,999.99"
@ PROW(),29   SAY CHR(27)+CHR(70)
@ PROW()+1,01 SAY "==============================================================================="
@ PROW()+3,21 SAY "MOVIMENTO DO DIA"
@ PROW(),55   SAY "ACUMULADO DO MES"
@ PROW()+1,01 SAY "-------------------------------------------------------------------------------"
@ PROW()+1,20 SAY "PAX"
@ PROW(),28   SAY "APTO"
@ PROW(),37   SAY "RECEITA"
@ PROW(),53   SAY "PAX"
@ PROW(),61   SAY "APTO"
@ PROW(),70   SAY "RECEITA"
@ PROW()+1,01 SAY "Saldo"
@ PROW(),19   SAY SALDOPAX   PICT "@E 9999"
@ PROW(),28   SAY SALDOAPTO  PICT "@E 9999"
@ PROW(),36   SAY SALDORECE  PICT "@E 999,999.99"
@ PROW(),53   SAY MMESSALPAX PICT "@E 9999"
@ PROW(),62   SAY MMESSALAP  PICT "@E 9999"
@ PROW(),68   SAY MMESSALR   PICT "@E 999,999.99"
@ PROW()+1,01 SAY"Entrada"
@ PROW(),19   SAY ENTRAPAX   PICT "@E 9999"
@ PROW(),28   SAY ENTRAAPTO  PICT "@E 9999"
@ PROW(),36   SAY ENTRARECE  PICT "@E 999,999.99"
@ PROW(),53   SAY MMESENTPAX PICT "@E 9999"
@ PROW(),62   SAY MMESENTAP  PICT "@E 9999"
@ PROW(),68   SAY MMESENTRE  PICT "@E 999,999.99"
@ PROW()+1,01 SAY "Sub_Total"
@ PROW(),19   SAY STOTALPAX   PICT "@E 9999"
@ PROW(),28   SAY STOTALAPTO  PICT "@E 9999"
@ PROW(),36   SAY STOTALRECE  PICT "@E 999,999.99"
@ PROW(),53   SAY MMESSTPAX   PICT "@E 9999"
@ PROW(),62   SAY MMESSTAP    PICT "@E 9999"
@ PROW(),68   SAY MMESSTRE    PICT "@E 999,999.99"
@ PROW()+1,01 SAY "Saida"
@ PROW(),19   SAY SAIDAPAX    PICT "@E 9999"
@ PROW(),28   SAY SAIDAAPTO   PICT "@E 9999"
@ PROW(),36   SAY SAIDARECE   PICT "@E 999,999.99"
@ PROW(),53   SAY MMESSAIPAX  PICT "@E 9999"
@ PROW(),62   SAY MMESSAIAP   PICT "@E 9999"
@ PROW(),68   SAY MMESSAIRE   PICT "@E 999,999.99"
@ PROW()+1,01 SAY "Saldo do Dia"
@ PROW(),19   SAY SALDODPAX    PICT "@E 9999"
@ PROW(),28   SAY SALDODAPTO   PICT "@E 9999"
@ PROW(),36   SAY SALDODRECE   PICT "@E 999,999.99"
@ PROW(),53   SAY MMESSALDP    PICT "@E 9999"
@ PROW(),62   SAY MMESSDAP     PICT "@E 9999"
@ PROW(),68   SAY MMESSDRE     PICT "@E 999,999.99"
@ PROW()+1,01 SAY "% Ocupacao"
@ PROW(),17   SAY OCUPAPAX     PICT "@E 999.99"
@ PROW(),26   SAY OCUPAAPTO    PICT "@E 999.99"
@ PROW(),50   SAY MMESOCUPAX   PICT "@E 9999.99"
@ PROW(),59   SAY MMESOCUAP    PICT "@E 9999.99"
@ PROW()+1,01 SAY "Val. Med. P/Pax"
@ PROW(),40   SAY VALPAX       PICT "@E 999.99"
@ PROW(),72   SAY MMESVALREP   PICT "@E 999.99"
@ PROW()+1,01 SAY "Val. Med. P/Apto"
@ PROW(),40   SAY VALAPTO      PICT "@E 999.99"
@ PROW(),72   SAY MMESVALREA   PICT "@E 999.99"
DO RODAPE
JANELA(02)
SET DEVICE TO SCREEN

IF VERI=02
   IF MDATA=CONTROLE->BMD .AND. MHBMD=CONTROLE->HBMD
      SELE 11
      DBGOTOP()
      DO WHILE .T.
         IF LASTREC()<1
            IF TRAVAREG()
               REPL_VAR()
            ENDIF
         ELSE
            IF RLOCK()
               REPL_VAR()
               UNLOCK
               EXIT
            ELSE
               MENS('Arquivo '+ALIAS()+' sendo utilizado !!!')
            ENDIF
         ENDIF
      ENDDO
      SELE 12
      DO WHILE .T.
         IF RLOCK()
            MBMD=BMD+1
            REPL BMD  WITH MBMD
            REPL HBMD WITH MHBMD
            UNLOCK
            EXIT
         ELSE
            MENS('Arquivo sendo Utilizado !!!')
         ENDIF
      ENDDO
   ENDIF
ENDIF
RETURN
